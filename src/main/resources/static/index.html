<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Restaurant Order Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(180, 180, 180, 0.7);
            border-radius: 999px;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 p-6 flex items-center justify-center">

<div class="w-full max-w-5xl bg-white/80 backdrop-blur-xl border border-gray-200 shadow-2xl rounded-3xl p-8">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 flex items-center gap-2">
                üçΩÔ∏è AI Restaurant Order Assistant
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                Describe your cravings ‚Äî the AI will build and refine your order.
            </p>
        </div>

        <div class="flex items-center gap-5 mt-4 md:mt-0">
            <div class="text-right">
                <p id="welcomeUser" class="text-gray-700 text-sm font-semibold"></p>
                <p class="text-gray-400 text-xs">Signed in</p>
            </div>
            <button onclick="logout()"
                class="px-4 py-2 bg-red-500 text-white rounded-xl shadow hover:bg-red-600 transition">
                Logout
            </button>
        </div>
    </div>

    <!-- LOGIN WARNING -->
    <div id="lockedMessage" class="hidden p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 mb-4">
        <strong>You must log in first.</strong>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[1.1fr_1.3fr] gap-6">

        <!-- LEFT SIDE -->
        <div class="space-y-4">

            <!-- Order Form -->
            <div class="border border-gray-200 bg-white shadow-md rounded-2xl p-5">
                <h2 class="text-lg font-semibold mb-2 text-gray-800">Describe Your Order</h2>
                <p class="text-xs text-gray-500 mb-3">
                    Ex: ‚ÄúA chicken shawarma wrap, fries, and a strawberry smoothie.‚Äù
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Name for Order</label>
                        <input id="customerName"
                            class="w-full mt-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-xl text-sm"
                            placeholder="Optional">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">What would you like?</label>
                        <textarea id="orderDescription" rows="4"
                            class="w-full mt-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-xl text-sm"
                            placeholder="Describe your full meal here..."></textarea>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">Preferences</label>
                        <input id="extraPrefs"
                            class="w-full mt-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-xl text-sm"
                            placeholder="Allergies, no nuts, halal only, extra spicy...">
                    </div>
                </div>

                <button id="generateBtn"
                    class="mt-4 w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow hover:scale-[1.02] transition font-semibold">
                    Build My Order ‚ú®
                </button>

                <div class="flex gap-2 mt-3 text-[10px] text-gray-400 flex-wrap">
                    <span class="px-2 py-1 bg-gray-100 border rounded-full">Try: ‚ÄúMake it under $12‚Äù</span>
                    <span class="px-2 py-1 bg-gray-100 border rounded-full">Try: ‚ÄúHealthy meal‚Äù</span>
                    <span class="px-2 py-1 bg-gray-100 border rounded-full">Try: ‚ÄúLarge meal, extra sauce‚Äù</span>
                </div>
            </div>

            <!-- Error -->
            <div id="errorDisplay" class="hidden p-3 bg-red-100 border border-red-300 rounded-xl text-red-700 text-sm"></div>

            <!-- Order Summary -->
            <div id="suggestionsDisplay"
                 class="hidden p-5 bg-blue-50 border border-blue-200 rounded-2xl shadow-inner">
                <h2 class="text-lg font-bold text-gray-800 mb-2">AI Order Summary</h2>
                <div id="suggestionsContent" class="text-gray-700 text-sm"></div>
            </div>
        </div>

        <!-- RIGHT SIDE : CHAT -->
        <div class="border border-gray-200 bg-white shadow-md rounded-2xl p-5 flex flex-col">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Chat with Your AI Server</h2>
            <p class="text-xs text-gray-500 mb-3">Ask follow-up questions or customize your order.</p>

            <div id="chatHistoryDisplay"
                 class="flex-1 border bg-gray-50 p-3 rounded-xl space-y-2 overflow-y-auto scrollbar-thin text-sm"
                 style="max-height: 350px;">
            </div>

            <div class="mt-3 flex gap-2">
                <input id="chatInput"
                    class="flex-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-xl text-sm"
                    placeholder="Type your message...">
                <button id="sendChatBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-xl shadow hover:bg-blue-600 transition">
                    Send
                </button>
            </div>
        </div>

    </div>
</div>

<script>
/* =============================
   SESSION CHECK
============================= */
async function checkSession() {
    const res = await fetch("/session");
    if (!res.ok) {
        document.getElementById("lockedMessage").classList.remove("hidden");
        setTimeout(() => window.location.href = "/login.html", 800);
        return;
    }
    const { username } = await res.json();
    document.getElementById("welcomeUser").textContent = "Welcome, " + username;
}
checkSession();

function logout() { window.location.href = "/logout"; }

/* =============================
   DOM ELEMENTS
============================= */
const generateBtn = document.getElementById("generateBtn");
const customerNameInput = document.getElementById("customerName");
const orderInput = document.getElementById("orderDescription");
const prefsInput = document.getElementById("extraPrefs");

const suggestionsDisplay = document.getElementById("suggestionsDisplay");
const suggestionsContent = document.getElementById("suggestionsContent");
const errorDisplay = document.getElementById("errorDisplay");

const chatHistoryDisplay = document.getElementById("chatHistoryDisplay");
const chatInput = document.getElementById("chatInput");
const sendChatBtn = document.getElementById("sendChatBtn");

let chatHistory = [];

/* =============================
   HELPERS
============================= */
function showError(msg) {
    errorDisplay.textContent = msg;
    errorDisplay.classList.remove("hidden");
}

function hideError() {
    errorDisplay.classList.add("hidden");
}

function appendChat(sender, msg, type = "user") {
    const bubble = document.createElement("div");
    bubble.classList.add("px-3", "py-2", "rounded-xl", "max-w-[85%]");

    if (type === "user") {
        bubble.classList.add("bg-blue-600", "text-white", "ml-auto");
    } else {
        bubble.classList.add("bg-gray-200", "text-gray-800", "mr-auto");
    }

    bubble.innerHTML = `<strong>${sender}:</strong> ${msg}`;
    chatHistoryDisplay.appendChild(bubble);
    chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
}

async function callAI(history, source) {
    try {
        const res = await fetch("/ai/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(history)
        });

        if (!res.ok) throw new Error("AI request failed.");

        const text = await res.text();

        appendChat("AI", text, "ai");

        if (source === "generate") {
            suggestionsContent.innerHTML = text.replace(/\n/g, "<br>");
            suggestionsDisplay.classList.remove("hidden");
        }
    } catch (err) {
        showError(err.message);
    }
}

/* =============================
   EVENTS
============================= */
generateBtn.addEventListener("click", () => {
    hideError();

    const name = customerNameInput.value.trim() || "Customer";
    const order = orderInput.value.trim();
    const prefs = prefsInput.value.trim();

    if (!order) {
        showError("Please describe your order first!");
        return;
    }

    const systemPrompt =
        "You are an AI restaurant ordering assistant. Build clear meal orders with items, sizes, add-ons, and notes.";

    const firstMsg =
        `Name: ${name}\nOrder: ${order}\nPreferences: ${prefs || "None"}`;

    chatHistory = [systemPrompt, firstMsg];
    appendChat("You", order);
    callAI(chatHistory, "generate");
});

sendChatBtn.addEventListener("click", () => {
    const msg = chatInput.value.trim();
    if (!msg) return;

    chatInput.value = "";
    appendChat("You", msg);
    chatHistory.push(msg);
    callAI(chatHistory, "chat");
});

chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendChatBtn.click();
});
</script>
</body>
</html>